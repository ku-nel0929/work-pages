<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="google-site-verification" content="YdkYdalhqx1MHFQb7aFVKFsD7n2bUpgKDN--q0rWI9E" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LegalService",
      "name": "植村 土地家屋調査士・行政書士事務所",
      "image": "https://ku-nel0929.github.io/work-pages/sokkia-bg.png",
      "url": "https://ku-nel0929.github.io/work-pages/",
      "telephone": "080-7231-9467",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "花城町12番6号",
        "addressLocality": "花巻市",
        "addressRegion": "岩手県",
        "postalCode": "025-0075",
        "addressCountry": "JP"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": 39.3905,
        "longitude": 141.1186
      },
      "openingHoursSpecification": {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday"],
        "opens": "09:00",
        "closes": "18:00"
      },
      "priceRange": "相談無料",
      "description": "岩手県花巻市の農地転用許可申請、土地の測量・分筆登記、相続手続きなら植村事務所へ。SIMAデータ読込による位置特定や、登録免許税計算などの便利ツールも無料公開中。"
    }
    </script>

    <title>位置図作成・SIMA読込・農地転用 | 植村 土地家屋調査士・行政書士事務所</title>
    <meta name="description" content="岩手県花巻市で農地転用許可申請、土地の測量、分筆登記をお考えなら当事務所へ。SIMAファイルを読み込んで位置図を作成するツールや、登録免許税計算ツールなどを無料公開中。">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- CSS設定 --- */
        :root {
            --primary-color: #0f2350; /* ネイビー */
            --survey-color: #c5a059;  /* ゴールド */
            --admin-color: #3b6c9b;   /* 青 */
            --text-color: #333;
            --white: #ffffff;
            --bg-body: #f0f0f0;
            --bg-form: #f9fbfd;
        }
        
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: var(--text-color);
            line-height: 1.6;
            background-color: var(--bg-body);
        }

        a { text-decoration: none; color: inherit; }
        img { max-width: 100%; height: auto; }
        
        /* --- ヘッダー --- */
        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px 0;
            text-align: center;
            max-width: 1000px;
            margin: 0 auto; 
        }
        .logo { font-size: 1.4rem; font-weight: bold; }

        /* --- メインビジュアル --- */
        .hero {
            position: relative;
            max-width: 1000px;
            margin: 0 auto;
            background-color: #87CEEB;
            background-image: url('sokkia-bg.png');
            background-size: cover;
            background-position: center;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--white);
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
        }
        .hero::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.3);
        }
        .hero-content {
            position: relative;
            z-index: 2;
        }
        .hero-content h1 { font-size: 2.2rem; margin: 0 20px; font-weight: bold; line-height: 1.4; }

        @media (max-width: 768px) {
            .hero { height: 300px; }
            .hero-content h1 { font-size: 1.5rem; }
        }

        /* --- コンテンツ枠 --- */
        .main-wrapper {
            max-width: 1000px;
            margin: 0 auto;
            background-color: var(--white);
            padding-top: 50px; 
            padding-bottom: 60px;
        }

        /* --- 業務選択ボタン --- */
        .main-actions {
            margin-top: 0;
            padding: 0 20px;
        }
        .action-grid {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .action-box {
            flex: 1;
            min-width: 280px;
            padding: 30px 20px;
            border-radius: 8px;
            text-align: center;
            color: var(--white);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        .action-box:hover { transform: translateY(-3px); }
        .box-survey { background-color: var(--survey-color); }
        .box-admin { background-color: var(--admin-color); }
        
        .box-title { display: block; font-size: 1.4rem; font-weight: bold; margin-bottom: 15px; }
        .phone-area {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        .phone-number { font-size: 1.4rem; font-weight: bold; }

        /* --- お問い合わせフォーム --- */
        .contact-section {
            padding: 60px 20px;
        }
        .section-title {
            text-align: center;
            color: var(--primary-color);
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .contact-form {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-form);
            padding: 30px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary-color); }
        .form-input, .form-textarea, .form-select {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem;
        }
        .form-textarea { height: 120px; }
        .required { background: #d9534f; color: white; padding: 2px 5px; font-size: 0.7rem; border-radius: 3px; margin-left: 5px; }
        .optional { background: #999; color: white; padding: 2px 5px; font-size: 0.7rem; border-radius: 3px; margin-left: 5px; }
        
        .submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 30px auto 0;
            width: 100%;
            max-width: 300px;
        }
        .submit-btn:hover { opacity: 0.9; }

        /* --- コラム --- */
        .column-section { padding: 40px 20px; max-width: 900px; margin: 0 auto; }
        .column-article { margin-bottom: 40px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .column-title { color: var(--primary-color); font-size: 1.4rem; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .column-text { font-size: 0.95rem; line-height: 1.8; color: #444; }
        .nou-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 0.9rem; }
        .nou-table th, .nou-table td { border: 1px solid #ccc; padding: 10px; }
        .nou-table th { background-color: #f0f0f0; text-align: center; width: 20%; }

        /* --- ツール共通 --- */
        .tool-section { padding: 40px 20px; max-width: 800px; margin: 0 auto 40px; background-color: #f5f8fc; border-radius: 8px; border: 1px solid #dce4ec; }
        .tool-box { background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tool-header { text-align: center; margin-bottom: 15px; font-weight: bold; color: var(--primary-color); border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        .tool-input-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .tool-btn { background-color: var(--admin-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .tool-btn:hover { opacity: 0.9; }
        .active-btn { background-color: #0f2350 !important; }
        .inactive-btn { background-color: #6c757d !important; opacity: 0.8; }
        
        .tool-result { background-color: #0f2350; color: white; padding: 20px; border-radius: 5px; }
        .tool-result-item { margin-bottom: 10px; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px; display: flex; align-items: center; }
        .tool-result-item:last-child { border-bottom: none; margin-bottom: 0; }
        .tool-label { font-size: 0.8rem; opacity: 0.8; display: block; min-width: 100px; }
        .zodiac-icon { width: 28px; height: 28px; margin-left: 10px; fill: #fff; vertical-align: middle; }

        /* --- 相続図 --- */
        .family-input-row { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .family-input-row input, .family-input-row select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 0; }
        .btn-add { background-color: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .btn-del { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        #canvasContainer { text-align: center; overflow-x: auto; margin-top: 20px; border: 1px solid #ddd; background: #fff; }
        canvas { max-width: 100%; height: auto; }

        /* --- マップ用 --- */
        /* ★高さ固定にして表示崩れを防ぐ */
        .map-result-container {
            position: relative;
            width: 100%;
            height: 500px; /* 固定高さ */
            background: #eee;
            margin-top: 15px;
            border: 1px solid #ccc;
            overflow: hidden;
        }
        .map-result-container iframe, .map-result-container .leaflet-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; z-index: 1;
        }
        
        .file-upload-area {
            border: 3px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; background: #fafafa; margin-bottom: 15px; cursor: pointer; transition: 0.3s;
        }
        .file-upload-area:hover { background: #eef4fb; border-color: var(--admin-color); }

        /* ▼▼▼ 印刷用スタイル ▼▼▼ */
        #printHeader { display: none; }

        @media print {
            @page { size: A4 portrait; margin: 5mm; }
            body { background: white !important; height: 100vh; margin: 0 !important; padding: 0 !important; }
            body > * { display: none !important; }
            
            .main-wrapper { display: block !important; padding: 0 !important; margin: 0 !important; width: 100% !important; height: 100% !important; }
            
            /* 非表示要素 */
            header, footer, .hero, .main-actions, .contact-section, .column-section, .office-info,
            .tool-section > h2, .tool-section > p, 
            .tool-box > *:not(.map-result-container):not(#printHeader),
            .file-upload-area, #simaStatus, .tool-input-group, #tabChiban, #tabSima, .tool-btn {
                display: none !important;
            }

            .tool-section, .tool-box {
                border: none !important; box-shadow: none !important; margin: 0 !important; padding: 0 !important; width: 100% !important; height: 100% !important;
            }

            #printHeader {
                display: block !important; width: 100%; margin-bottom: 5mm; border-bottom: 2px solid #000; padding-bottom: 2mm;
            }
            #printHeader h1 { font-size: 24pt; margin: 0; }
            #printHeader p { font-size: 16pt; margin: 2mm 0 0 0; }

            /* 地図エリア最大化 */
            .map-result-container {
                display: block !important; position: static !important;
                height: 250mm !important; /* A4縦フィット */
                width: 100% !important;
                border: 2px solid #000 !important;
                box-sizing: border-box !important;
            }
            
            /* プロット(点)を消す */
            .sima-marker { display: none !important; }
        }

        @media (max-width: 600px) {
            .family-input-row { gap: 5px; }
            .heir-rel { flex-basis: 35%; }
            .heir-name { flex: 1; }
            .heir-addr { flex-basis: 100% !important; margin-top: 5px; width: 100%; }
            .btn-del { margin-left: auto; }
        }

        .office-info { text-align: center; margin-top: 50px; padding: 20px; background: #f9f9f9; }
        .map-container { width: 100%; height: 350px; margin-top: 20px; background: #eee; }
        footer { background-color: var(--primary-color); color: #aaa; text-align: center; padding: 20px 0; font-size: 0.8rem; max-width: 1000px; margin: 0 auto; }
    </style>
</head>
<body>

<header>
    <div class="logo">植村 土地家屋調査士・行政書士事務所</div>
</header>

<section class="hero">
    <div class="hero-content">
        <h1>家づくり・土地活用。<br>「測量」と「許認可」をワンストップで。</h1>
    </div>
</section>

<div class="main-wrapper">
    <div class="main-actions">
        <div class="action-grid">
            <div class="action-box box-survey">
                <a href="business-guide.png" target="_blank" style="text-decoration:none; color:white;">
                    <span class="box-title" style="text-decoration:underline; text-underline-offset: 4px;">
                        土地家屋調査士業務 <i class="fa-regular fa-image" style="font-size:0.8em;"></i>
                    </span>
                </a>
                <a href="tel:08072319467">
                    <div class="phone-area">
                        <i class="fa-solid fa-mobile-screen"></i>
                        <span class="phone-number">080-7231-9467</span>
                    </div>
                </a>
            </div>
            <div class="action-box box-admin">
                <a href="admin-guide.png" target="_blank" style="text-decoration:none; color:white;">
                    <span class="box-title" style="text-decoration:underline; text-underline-offset: 4px;">
                        行政書士業務 <i class="fa-regular fa-image" style="font-size:0.8em;"></i>
                    </span>
                </a>
                <a href="tel:07066256247">
                    <div class="phone-area">
                        <i class="fa-solid fa-mobile-screen"></i>
                        <span class="phone-number">070-6625-6247</span>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <div class="contact-section">
        <h2 class="section-title">お問い合わせ・ご相談</h2>
        <form action="https://formspree.io/f/mdkqdjlz" method="POST" class="contact-form" autocomplete="off">
            <div class="form-group">
                <label class="form-label">お名前 <span class="required">必須</span></label>
                <input type="text" name="お名前" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">メールアドレス <span class="required">必須</span></label>
                <input type="email" name="email" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">お電話番号 <span class="optional">任意</span></label>
                <input type="tel" name="電話番号" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">ご相談内容 <span class="required">必須</span></label>
                <textarea name="詳細" class="form-textarea" required></textarea>
            </div>
            <button type="submit" class="submit-btn">送信する</button>
        </form>
    </div>

    <div class="column-section">
        <h2 class="section-title">お役立ち情報</h2>
        <article class="column-article">
            <h3 class="column-title" style="color:#d9534f;"><i class="fa-solid fa-triangle-exclamation"></i> 【重要】相続登記義務化</h3>
            <p class="column-text">2024年4月より相続登記が義務化されました。放置すると過料の対象となる可能性があります。</p>
        </article>
        </div>

    <div class="tool-section">
        <h2 class="section-title">【便利ツール】現場位置図検索</h2>
        <p style="text-align:center; font-size:0.9rem; margin-bottom:20px;">
            地番検索、またはSIMAファイルから地図を表示します。<br>
            <small style="color:#d9534f;">※地番はGoogleマップのデータに依存します。SIMAは世界測地系(第10系)対応。</small>
        </p>
        
        <div class="tool-box" id="mapToolBox">
            <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                <button type="button" class="tool-btn active-btn" id="tabChiban" onclick="switchMapMode('chiban')">地番から検索</button>
                <button type="button" class="tool-btn inactive-btn" id="tabSima" onclick="switchMapMode('sima')">SIMAから特定</button>
            </div>

            <div id="modeChiban">
                <div class="tool-input-group">
                    <input type="text" id="mapCity" class="form-input" placeholder="市町村 (例: 花巻市)" value="花巻市" style="flex:1;">
                    <input type="text" id="mapTown" class="form-input" placeholder="町名・大字 (例: 花城町)" style="flex:1;">
                    <input type="text" id="mapLot" class="form-input" placeholder="地番 (例: 12-6)" style="flex:1;">
                </div>
                <div style="text-align:center; margin-bottom:10px;">
                    <button type="button" id="showMapBtn" class="tool-btn">地図を表示</button>
                </div>
            </div>

            <div id="modeSima" style="display:none;">
                <div class="file-upload-area" id="dropArea" onclick="document.getElementById('simaFile').click()">
                    <i class="fa-solid fa-file-arrow-up" style="font-size:2rem; color:#aaa; margin-bottom:10px;"></i><br>
                    <span style="font-size:0.95rem; font-weight:bold; color:#0f2350;">SIMAファイルをドロップ</span><br>
                    <span style="font-size:0.85rem; color:#666;">またはクリックして選択</span>
                    <input type="file" id="simaFile" accept=".sim,.sima,.txt" style="display:none;">
                </div>
                <div id="simaStatus" style="text-align:center; font-size:0.9rem; color:#0f2350; font-weight:bold; margin-bottom:10px;"></div>
            </div>
            
            <div id="printHeader">
                <h1>位置図</h1>
                <p>所在：<span id="printLocation"></span></p>
            </div>

            <div class="map-result-container" id="mapContainer">
                <iframe id="mapFrame" src="https://maps.google.co.jp/maps?q=花巻市役所&output=embed&t=m&z=15" frameborder="0" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                <div id="simaLeafletMap" style="width:100%; height:100%; display:none;"></div>
            </div>
            
            <div style="text-align:center; margin-top:15px;">
                <button type="button" id="printMapBtn" class="tool-btn" style="background-color:#c5a059;">
                    <i class="fa-solid fa-print"></i> 位置図作成 (PDF保存・印刷)
                </button>
            </div>
        </div>
    </div>

    <div class="tool-section">
        <h2 class="section-title">【便利ツール】坪 ⇔ 平米(㎡) ⇔ 畳 換算</h2>
        <div class="tool-box">
            <div class="family-input-row"><span class="tool-label">坪数</span><input type="number" id="tsuboInput" class="form-input"></div>
            <div class="family-input-row"><span class="tool-label">平米</span><input type="number" id="m2Input" class="form-input"></div>
            <div class="family-input-row"><span class="tool-label">畳数</span><input type="number" id="joInput" class="form-input"></div>
        </div>
    </div>

    <div class="tool-section" style="margin-top:-20px;">
        <h2 class="section-title">【便利ツール】登録免許税 (概算) 計算</h2>
        <div class="tool-box">
            <div class="family-input-row"><span class="tool-label">評価額</span><input type="number" id="taxValue" class="form-input" placeholder="円"></div>
            <div style="display:flex; gap:10px; margin-top:10px; justify-content:center;">
                <button class="tool-btn" onclick="calcTax(0.004, '所有権保存')">保存 (0.4%)</button>
                <button class="tool-btn" onclick="calcTax(0.02, '所有権移転')">移転 (2.0%)</button>
                <button class="tool-btn" onclick="calcTax(0.004, '抵当権設定')">抵当権 (0.4%)</button>
            </div>
            <div id="taxResult" style="background:#f9f9f9; padding:10px; margin-top:15px; text-align:center;">---</div>
        </div>
    </div>

    <div class="tool-section">
        <h2 class="section-title">【無料ツール】相続関係説明図メーカー</h2>
        <div class="tool-box">
            <div class="tool-header">被相続人</div>
            <div class="family-input-row"><input type="text" id="decedentName" placeholder="氏名" style="flex:2;"><input type="text" id="decedentDate" placeholder="死亡日" style="flex:2;"></div>
            <div class="family-input-row"><input type="text" id="decedentAddress" placeholder="住所" style="flex:4;"></div>
            <div class="tool-header" style="margin-top:20px;">相続人</div>
            <div id="heirsContainer">
                <div class="family-input-row"><select class="heir-rel" disabled><option>配偶者</option></select><input type="text" class="heir-name" placeholder="氏名"><input type="text" class="heir-addr" placeholder="住所"></div>
            </div>
            <div style="text-align:right; margin:10px 0;"><button type="button" class="btn-add" id="addHeirBtn">＋追加</button></div>
            <div style="text-align:center;"><button class="tool-btn" id="genMapBtn">作成</button> <button class="tool-btn" id="downloadMapBtn" style="display:none; bg-color:#c5a059;">保存</button></div>
        </div>
        <div id="canvasContainer" style="display:none;"><canvas id="familyCanvas" width="800" height="600"></canvas></div>
    </div>

    <div class="tool-section">
        <h2 class="section-title">【便利ツール】西暦・和暦・年齢・干支</h2>
        <div class="tool-box">
            <div class="tool-input-group">
                <select id="eraSelect" class="form-select"><option value="AD">西暦</option><option value="Reiwa">令和</option><option value="Heisei">平成</option><option value="Showa">昭和</option></select>
                <input type="number" id="yearInput" class="form-input" placeholder="年">
            </div>
            <div class="tool-result">
                <div class="tool-result-item"><span class="tool-label">西暦</span><span id="resAD">---</span></div>
                <div class="tool-result-item"><span class="tool-label">和暦</span><span id="resEra">---</span></div>
                <div class="tool-result-item"><span class="tool-label">年齢</span><span id="resAge">---</span></div>
                <div class="tool-result-item"><span class="tool-label">干支</span><span id="resZodiac">---</span></div>
            </div>
        </div>
    </div>

    <div class="tool-section" style="margin-top:-20px;">
        <h2 class="section-title">【便利ツール】郵便番号 ↔ 住所</h2>
        <div class="tool-box">
            <div class="tool-header">郵便番号 <i class="fa-solid fa-arrow-right"></i> 住所</div>
            <div class="tool-input-group"><input type="text" id="zipInput" class="form-input"><button id="zipSearchBtn" class="tool-btn">検索</button></div>
            <div id="zipResult" style="padding:10px;"></div>
        </div>
        <div class="tool-box">
            <div class="tool-header">住所 <i class="fa-solid fa-arrow-right"></i> 郵便番号</div>
            <div class="tool-input-group"><input type="text" id="addrInput" class="form-input"><button id="addrSearchBtn" class="tool-btn" style="bg-color:#4285F4;">検索</button></div>
        </div>
    </div>
    
    <script>
        // --- 関数定義 ---
        function calcTax(rate, typeName) {
            const val = parseInt(document.getElementById('taxValue').value);
            const res = document.getElementById('taxResult');
            if(!val || val<=0) { res.innerHTML='<span style="color:red">数値を入力してください</span>'; return; }
            const base = Math.floor(val/1000)*1000;
            let t = Math.floor(base*rate); t = Math.floor(t/100)*100; if(t<1000) t=1000;
            res.innerHTML = `<strong>${typeName}</strong><br><span style="font-size:1.4rem; color:#c5a059;">約 ${t.toLocaleString()} 円</span>`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Leaflet & State
            let leafletMap = null; 
            let simaLayerGroup = null; 
            let currentMode = "chiban"; 
            let currentQueryOrCoord = "";

            const showMapBtn = document.getElementById('showMapBtn');
            const printMapBtn = document.getElementById('printMapBtn');
            const mapFrame = document.getElementById('mapFrame');
            const simaLeafletMap = document.getElementById('simaLeafletMap');
            const printLocation = document.getElementById('printLocation');

            // --- マップモード切替 ---
            window.switchMapMode = function(mode) {
                currentMode = mode;
                const btnChiban = document.getElementById('tabChiban');
                const btnSima = document.getElementById('tabSima');
                
                if(mode === 'chiban') {
                    document.getElementById('modeChiban').style.display = 'block';
                    document.getElementById('modeSima').style.display = 'none';
                    mapFrame.style.display = 'block';
                    simaLeafletMap.style.display = 'none';
                    btnChiban.className = 'tool-btn active-btn';
                    btnSima.className = 'tool-btn inactive-btn';
                } else {
                    document.getElementById('modeChiban').style.display = 'none';
                    document.getElementById('modeSima').style.display = 'block';
                    mapFrame.style.display = 'none';
                    simaLeafletMap.style.display = 'block';
                    btnSima.className = 'tool-btn active-btn';
                    btnChiban.className = 'tool-btn inactive-btn';
                    if(leafletMap) setTimeout(() => { leafletMap.invalidateSize(); }, 200);
                }
            };

            // A. 地番検索
            if (showMapBtn) {
                showMapBtn.addEventListener('click', function() {
                    const city = document.getElementById('mapCity').value;
                    const town = document.getElementById('mapTown').value;
                    const lot = document.getElementById('mapLot').value;
                    if (!city || !town) { alert("市町村と町名を入力してください"); return; }
                    const query = `${city} ${town} ${lot}`;
                    currentQueryOrCoord = query;
                    const embedUrl = `https://maps.google.co.jp/maps?q=${encodeURIComponent(query)}&output=embed&t=m&z=17`; 
                    mapFrame.src = embedUrl;
                });
            }

            // B. SIMAファイル読込
            const simaFile = document.getElementById('simaFile');
            const simaStatus = document.getElementById('simaStatus');
            const dropArea = document.getElementById('dropArea');

            function initLeaflet() {
                if(leafletMap) return;
                const gsiTile = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: "地理院" });
                const gsiPhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/ort/{z}/{x}/{y}.jpg', { attribution: "地理院" });
                leafletMap = L.map('simaLeafletMap', { center: [39.3905, 141.1186], zoom: 15, layers: [gsiTile] });
                L.control.layers({ "標準地図": gsiTile, "航空写真": gsiPhoto }).addTo(leafletMap);
                simaLayerGroup = L.layerGroup().addTo(leafletMap);
            }

            if (simaFile && dropArea) {
                if(typeof proj4 !== 'undefined') {
                    // 第10系定義
                    proj4.defs("EPSG:6678", "+proj=tmerc +lat_0=40 +lon_0=140.8333333333333 +k=0.9999 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs");
                }

                // D&D
                dropArea.addEventListener('dragover', function(e) { e.preventDefault(); this.style.background = '#eef4fb'; }, false);
                dropArea.addEventListener('dragleave', function(e) { e.preventDefault(); this.style.background = '#fafafa'; }, false);
                dropArea.addEventListener('drop', function(e) { 
                    e.preventDefault(); 
                    this.style.background = '#fafafa';
                    if(e.dataTransfer.files.length > 0) { simaFile.files = e.dataTransfer.files; readSima(e.dataTransfer.files[0]); }
                }, false);

                simaFile.addEventListener('change', function(e) { if(e.target.files[0]) readSima(e.target.files[0]); });

                function readSima(file) {
                    simaStatus.textContent = "読み込み中...";
                    
                    // 自動でモード切替 & 初期化
                    switchMapMode('sima');
                    initLeaflet();

                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        const text = evt.target.result;
                        const lines = text.split(/\r\n|\n/);
                        const points = [];
                        
                        // 数値ペア探索
                        lines.forEach(line => {
                            const parts = line.trim().split(/[\s,]+/);
                            for(let i=0; i<parts.length-1; i++) {
                                const v1 = parseFloat(parts[i]); // X
                                const v2 = parseFloat(parts[i+1]); // Y
                                if(!isNaN(v1) && !isNaN(v2) && Math.abs(v1)>1000 && Math.abs(v2)>1000) {
                                    try {
                                        const wgs = proj4("EPSG:6678", "WGS84", [v2, v1]); // [Y, X]
                                        points.push([wgs[1], wgs[0]]); // [Lat, Lon]
                                    } catch(e){}
                                    break;
                                }
                            }
                        });

                        if(points.length === 0) {
                            simaStatus.textContent = "座標データなし";
                            alert("座標が見つかりませんでした。SIMAファイルか確認してください。");
                            return;
                        }

                        simaLayerGroup.clearLayers();
                        // ポリゴン（薄い赤）
                        const poly = L.polygon(points, {color: '#FF6666', weight: 3, fillOpacity:0.2}).addTo(simaLayerGroup);
                        // プロット（印刷時消す）
                        points.forEach(p => L.circleMarker(p, {radius:3, color:'blue', className:'sima-marker'}).addTo(simaLayerGroup));
                        
                        leafletMap.fitBounds(poly.getBounds());
                        simaStatus.textContent = `描画完了 (${points.length}点)`;
                        currentQueryOrCoord = ""; // SIMA時は空
                    };
                    reader.readAsText(file, "Shift_JIS");
                }
            }

            // 印刷
            if (printMapBtn) {
                printMapBtn.onclick = function() {
                    printLocation.textContent = currentQueryOrCoord;
                    alert("【印刷・保存のコツ】\n\n・用紙サイズ：A4\n・向き：縦\n・ヘッダー/フッター：オフ\n\nに設定すると綺麗に出力されます。");
                    window.print();
                };
            }

            // --- 2.坪平米 ---
            const tsuboInput=document.getElementById('tsuboInput');
            const m2Input=document.getElementById('m2Input');
            const joInput=document.getElementById('joInput');
            if(tsuboInput){
                const T=3.30578, J=1.6562;
                tsuboInput.addEventListener('input',function(){ const v=parseFloat(this.value); if(!isNaN(v)){m2Input.value=(v*T).toFixed(2);joInput.value=((v*T)/J).toFixed(2)}else{m2Input.value='';joInput.value=''} });
                m2Input.addEventListener('input',function(){ const v=parseFloat(this.value); if(!isNaN(v)){tsuboInput.value=(v/T).toFixed(2);joInput.value=(v/J).toFixed(2)}else{tsuboInput.value='';joInput.value=''} });
                joInput.addEventListener('input',function(){ const v=parseFloat(this.value); if(!isNaN(v)){m2Input.value=(v*J).toFixed(2);tsuboInput.value=((v*J)/T).toFixed(2)}else{tsuboInput.value='';m2Input.value=''} });
            }

            // --- 4.相続図 ---
            const genMapBtn=document.getElementById('genMapBtn');
            if(genMapBtn){
                const addBtn=document.getElementById('addHeirBtn'), heirsCont=document.getElementById('heirsContainer'), dlBtn=document.getElementById('downloadMapBtn'), cvsCont=document.getElementById('canvasContainer'), canvas=document.getElementById('familyCanvas'), ctx=canvas.getContext('2d');
                addBtn.onclick=function(){const d=document.createElement('div');d.className='family-input-row';d.innerHTML=`<select class="heir-rel" style="width:90px;"><option>長男</option><option>二男</option><option>長女</option><option>二女</option><option>子</option></select><input class="heir-name" placeholder="氏名" style="flex:1;"><input class="heir-addr" placeholder="住所" style="flex:2;"><button class="btn-del" onclick="this.parentElement.remove()">×</button>`;heirsCont.appendChild(d)};
                genMapBtn.onclick=function(){
                    // (描画処理省略・前回同様)
                    cvsCont.style.display='block'; dlBtn.style.display='inline-block';
                    ctx.fillStyle="#fff"; ctx.fillRect(0,0,800,600); ctx.fillStyle="#000"; ctx.font="20px sans-serif"; ctx.fillText("相続関係説明図",30,40);
                    // 簡易描画
                    const decName=document.getElementById('decedentName').value||"被相続人";
                    ctx.strokeRect(300,100,160,80); ctx.fillText(decName,310,145);
                };
                dlBtn.onclick=function(){const a=document.createElement('a');a.download='sozoku.png';a.href=canvas.toDataURL();a.click()};
            }

            // --- 5.年齢 ---
            const eraSel=document.getElementById('eraSelect'), yrIn=document.getElementById('yearInput');
            if(eraSel){
                const zD=["申","酉","戌","亥","子","丑","寅","卯","辰","巳","午","未"];
                const cE=function(){
                    const v=parseInt(yrIn.value); if(isNaN(v)){document.getElementById('resAge').innerText='---';return;}
                    let ad=v; if(eraSel.value=='Reiwa')ad+=2018; else if(eraSel.value=='Heisei')ad+=1988; else if(eraSel.value=='Showa')ad+=1925;
                    document.getElementById('resAD').innerText=ad+"年"; document.getElementById('resAge').innerText=(new Date().getFullYear()-ad)+"歳"; document.getElementById('resZodiac').innerText=zD[ad%12];
                };
                eraSel.onchange=cE; yrIn.oninput=cE;
            }

            // --- 6.郵便番号 ---
            const zBtn=document.getElementById('zipSearchBtn');
            if(zBtn){
                zBtn.onclick=function(){
                    let z=document.getElementById('zipInput').value.replace(/-/g,'');
                    if(z.length!=7)return;
                    fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode='+z).then(r=>r.json()).then(d=>{
                        document.getElementById('zipResult').innerText = d.results ? d.results[0].address1+d.results[0].address2+d.results[0].address3 : "該当なし";
                    });
                };
                document.getElementById('addrSearchBtn').onclick=function(){
                    const a=document.getElementById('addrInput').value; if(a)window.open('https://www.google.com/search?q='+encodeURIComponent(a)+'+郵便番号');
                };
            }
        });
    </script>
</div>

<footer>
    <p>© 2024 Uemura Land and House Investigator & Administrative Scrivener Office.</p>
</footer>

</body>
</html>
